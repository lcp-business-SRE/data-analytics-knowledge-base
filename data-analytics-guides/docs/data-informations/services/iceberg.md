---
sidebar_position: 4
title: Apache Iceberg
description: Apache Icebergに関しての解説
tags: [情報, サービス]
custom_react_root: true # コメント有無
---

## Apache Icebergとは

### 従来のデータレイク＋DWHの問題点

従来のデータレイク＋DWHのシステムはどんどん高度になっていくデータ活用のニーズにこたえる際に、以下のような問題点を抱えるようになってきています。

1. **データの整合性がとりにくい**
従来のデータレイクはデータを保存するだけだったため、データの記録ミスや、レコードの重複などが発生しかねない。

2. **データ量が肥大化すると、パフォーマンスが低下する**
データの記録時にパーティションを意識していなかったり、パーティションの粒度が粗すぎると、データ量が増えるにつれてクエリのパフォーマンスが低下します。しかし、パーティションの粒度を細かくしすぎると、データの書き込み時にパーティションの管理が煩雑になり、書き込み性能が低下したり、読み込み時に多くのファイルを読むため性能が低下してしまいます。
後からパーティションを変更することは難しいため、最初の設計でそれ以降の性能が決まってしまいます。
他にもストリーミングデータを取り込む際にデータが細分化してしまうことで、クエリのパフォーマンスが低下することもあります。

3. **個人情報対応が難しい**
従来のデータレイクでは、個々のレコードを取得したり、更新することが難しいため、個人情報の削除やマスキングによる保護といった措置を行うためには計算コストがかかる。

4. **データ形式の変化に追従するのが難しい**
従来のデータレイクでは、スキーマ変更を伴うデータ形式の変更に対応するためには、データを再構築する必要がある。これには莫大な時間とコストがかかるため、実際には新しい部分だけを追加することが多い。しかし、これではデータの整合性がとれなくなり、データの品質が低下してしまう。

5. **DWHとデータレイクの使い分けの中で、データがサイロ化しがち**
データがDWHとデータレイクの間で分断されると、データの一貫性が失われ、分析の精度が低下してしまう。

6. **特定のタイミングのデータの状態を再現することが難しい**
従来のデータレイクでは、特定のタイミングでのデータの状態を再現することが難しいため、ある時点でのデータを再現することができないため過去の分析の妥当性の検証などが難しくなってしまう。

これらの問題のうちいくつかはトランザクション処理が行えないことにより発生します。
そこで、トランザクションを組み込んだデータレイクのフォーマット、トランザクショナルデータレイクが生まれました。

### トランザクショナルデータレイクにできること

トランザクショナルデータレイクは、従来のデータレイクにトランザクション処理を組み込むことで、以下のようなことが可能になります。

1. **データの整合性を保つ**
トランザクション処理により、データの記録ミスやレコードの重複を防ぐことができます。

2. **データ量が肥大化してもパフォーマンスを保つ**
データの読み書きにおいて、トランザクション処理を行うことで、データ量が増加してもパフォーマンスを維持することができます。

3. **個人情報対応が容易になる**
トランザクション処理により、個々のレコードを取得したり、更新することが容易になるため、個人情報の削除やマスキングによる保護といった措置を行うことが容易になります。

4. **DWHとデータレイクの中間のような存在**
トランザクショナルデータレイクは、DWHとデータレイクの中間のような存在であり、両者の利点を活かすことができる。

### Apache Iceberg

Apache Icebergは、トランザクションを組み込んだオープンテーブルフォーマットの一つです。
テーブルフォーマットとは、取得したデータのほかに、それと紐づいたメタデータを所持することで様々な機能を提供できるファイルの管理方式のことです。その中でも特に企画がオープンソースとして公開されているものをオープンテーブルフォーマットと呼び、Apache Icebergもその一つです。
Icebergは、データレイクのフォーマットとして、以下のような特徴を持っています。

1. **トランザクション処理**
Icebergは、ACIDトランザクションをサポートしており、データの整合性を保ちながら、データの読み書きを行うことができます。また、特定のレコードに対する更新や削除も可能です。

2. **スキーマの進化**
Icebergは、スキーマの進化をサポートしています。この機能により、サービスの拡張によるデータベースの進化にも対応することができます。

3. **隠しパーティション(Hidden Partition)**
Icebergは、パーティションの柔軟な管理をサポートしており、データのパーティションを以前のデータに触ることなく変更することができます。これにより、煩雑なパーティション管理を避けたうえで、クエリのパフォーマンスを向上させることができます。
また、パーティションについて意識することなくクエリを行うこともできるようになっているため、使い勝手も向上します。

4. **Time Travel**
Icebergは、過去のデータの状態を再現するためのTime Travel機能を提供しており、特定の時点でのデータを簡単に取得することができます。これにより、過去の分析の妥当性の検証や、特定のタイミングでのデータの状態を再現することが容易になります。

5. **データの圧縮と最適化**
Icebergは、データの圧縮と最適化をサポートしており、データの読み書きのパフォーマンスを向上させることができます。これによって、ストリーミングデータの取り込み等で、データが細分化してしまっても一つの大きなファイルにまとめることができ、クエリのパフォーマンスを向上させることができます。

これらの機能により、Icebergは従来のデータレイクの持つ問題点を解決します。

## 個々の機能

### レコード単位での処理

Icebergは、レコード単位での処理をサポートしており、特定のレコードに対する更新や削除を行うことができます。
SQLのUPDATEやDELETE文を使用して、特定のレコードを更新したり削除することが可能です。

### データ構造の進化

Icebergは、スキーマの進化をサポートしており、データベースのスキーマを既にあるデータに影響を与えることなく変更することができます。また、パーティションの構造も変更することができ、データのパーティションを以前のデータに触ることなく変更することができます。
これにより、サービスの拡張によるデータベースの進化にも、データ分析の要件の変化、データ量の増加によるパーティションの変更にも対応することができます。

### Time Travel

Icebergは、Time Travel機能を提供しており、特定の時点でのデータを簡単に取得することができます。
これは個々のデータをメタデータを通じて管理しているため、特定の時点でのメタデータを参照することで古いデータを取得し、過去の状態の再現を実現しています。

### データの圧縮と最適化

Icebergは、データの圧縮と最適化をサポートしており、データの読み書きのパフォーマンスを向上させることができます。
これはメタデータを通じて管理しているデータを定期的に一低サイズのファイルになるように整理することで実現しています。
また、不要になったデータを削除することもでき、際限のないストレージコストの増加を防ぐことができます。
ただし、Time Travel機能には古いデータが残っている必要があるため、圧縮や最適化により古いデータが削除されると、Time Travel機能が利用できなくなることがあります。
